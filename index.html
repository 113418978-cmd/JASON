<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Virtual Horse Race Game</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 20px;
    }
    h1,h2,h3 {
      color: #facc15;
    }
    input, select, button, textarea {
      margin: 4px 0;
      padding: 6px 8px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
    }
    button {
      cursor: pointer;
      background: #3b82f6;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      margin: 6px 0;
    }
    #app, #admin {
      margin-top: 20px;
      padding: 16px;
      background: #111827;
      border-radius: 8px;
    }
    textarea {
      width: 100%;
      max-width: 600px;
    }
  </style>
</head>
<body>
  <h1>赛马游戏</h1>
  <div id="auth">
    <h2>注册</h2>
    <input id="reg-username" placeholder="用户名"><br>
    <input id="reg-password" type="password" placeholder="密码"><br>
    <button onclick="registerUser()">注册</button>
    <h2>登录</h2>
    <input id="login-username" placeholder="用户名"><br>
    <input id="login-password" type="password" placeholder="密码"><br>
    <button onclick="loginUser()">登录</button>
  </div>

  <div id="app" style="display:none;">
    <h2>欢迎, <span id="userName"></span>!</h2>
    <p>当前金币：<span id="userBalance"></span></p>
    <button onclick="logout()">退出登录</button>

    <h3>下注</h3>
    <label for="horseSelect">选择赛马：</label>
    <select id="horseSelect"></select><br>
    <label for="betAmount">下注金额：</label>
    <input id="betAmount" type="number" min="1" step="1"><br>
    <button onclick="placeBet()">开始赛马</button>
    <div id="result"></div>

    <div id="admin" style="display:none;">
      <h3>管理员面板</h3>
      <h4>更新赛马配置 (JSON)</h4>
      <textarea id="horsesJson" rows="8"></textarea><br>
      <button onclick="updateHorses()">更新赛马</button>
      <h4>给用户充值</h4>
      <input id="rechargeUser" placeholder="用户名"><br>
      <input id="rechargeAmount" type="number" placeholder="金额"><br>
      <button onclick="recharge()">充值</button>
    </div>
  </div>

<script>
const API_URL = 'https://virtual-horse-backend.onrender.com';

async function registerUser() {
  const username = document.getElementById('reg-username').value.trim();
  const password = document.getElementById('reg-password').value;
  if (!username || !password) {
    alert('请输入用户名和密码');
    return;
  }
  try {
    const res = await fetch(`${API_URL}/api/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();
    if (res.ok) {
      localStorage.setItem('token', data.token);
      loadUser();
    } else {
      alert(data.error || '注册失败');
    }
  } catch (err) {
    alert('网络错误');
  }
}

async function loginUser() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  if (!username || !password) {
    alert('请输入用户名和密码');
    return;
  }
  try {
    const res = await fetch(`${API_URL}/api/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();
    if (res.ok) {
      localStorage.setItem('token', data.token);
      loadUser();
    } else {
      alert(data.error || '登录失败');
    }
  } catch (err) {
    alert('网络错误');
  }
}

function logout() {
  localStorage.removeItem('token');
  document.getElementById('auth').style.display = '';
  document.getElementById('app').style.display = 'none';
}

async function loadUser() {
  const token = localStorage.getItem('token');
  if (!token) {
    document.getElementById('auth').style.display = '';
    document.getElementById('app').style.display = 'none';
    return;
  }
  try {
    const res = await fetch(`${API_URL}/api/me`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await res.json();
    if (!res.ok) {
      logout();
      return;
    }
    document.getElementById('auth').style.display = 'none';
    document.getElementById('app').style.display = '';
    document.getElementById('userName').textContent = data.username;
    document.getElementById('userBalance').textContent = data.balance;
    if (data.is_admin || data.username === 'admin') {
      document.getElementById('admin').style.display = '';
    } else {
      document.getElementById('admin').styl=e.display = 'none';
    
    await loadHorses();
  } catch (err) {
    alert('无法获取用户信息');
  }
}

async function loadHorses() {
  try {
    const res = await fetch(`${API_URL}/api/config`);
    const data = await res.json();
    const select = document.getElementById('horseSelect');
    select.innerHTML = '';
    data.horses.forEach((h, idx) => {
      const option = document.createElement('option');
      option.value = h.id;
      option.textContent = `${idx + 1} 号马 - ${h.name} (赔率 x${Number(h.odds).toFixed(2)})`;
      select.appendChild(option);
    });
    // preload horse json for admin
    document.getElementById('horsesJson').value = JSON.stringify(data.horses.map(h => ({ name: h.name, emoji: h.emoji, prob: Number(h.prob) })), null, 2);
  } catch (err) {
    console.error(err);
    alert('无法获取赛马数据');
  }
}

async function placeBet() {
  const stake = parseInt(document.getElementById('betAmount').value, 10);
  const horseId = document.getElementById('horseSelect').value;
  if (!stake || stake <= 0) {
    alert('请输入有效的下注金额');
    return;
  }
  try {
    const res = await fetch(`${API_URL}/api/bet`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: JSON.stringify({ horseId, stake })
    });
    const data = await res.json();
    if (!res.ok) {
      alert(data.error || '下注失败');
      return;
    }
    const winner = data.winnerHorseId;
    const selected = document.getElementById('horseSelect').value;
    let msg = '';
    if (String(winner) === String(selected)) {
      msg = `赢啦！净赚 ${data.netChange} 金币。`;
    } else {
      msg = `很遗憾，亏损 ${-data.netChange} 金币。`;
    }
    document.getElementById('result').textContent = msg;
    document.getElementById('userBalance').textContent = data.balance;
  } catch (err) {
    alert('下注请求失败');
  }
}

async function updateHorses() {
  const jsonStr = document.getElementById('horsesJson').value;
  let horses;
  try {
    horses = JSON.parse(jsonStr);
  } catch (e) {
    alert('JSON 格式错误');
    return;
  }
  try {
    const res = await fetch(`${API_URL}/api/admin/config`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: JSON.stringify({ horses })
    });
    const data = await res.json();
    if (!res.ok) {
      alert(data.error || '更新失败');
    } else {
      alert('马匹配置已更新');
      await loadHorses();
    }
  } catch (err) {
    alert('更新请求失败');
  }
}

async function recharge() {
  const username = document.getElementById('rechargeUser').value.trim();
  const amount = parseInt(document.getElementById('rechargeAmount').value, 10);
  if (!username || !amount) {
    alert('请输入用户名和金额');
    return;
  }
  try {
    const res = await fetch(`${API_URL}/api/admin/recharge`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: JSON.stringify({ username, amount })
    });
    const data = await res.json();
    if (!res.ok) {
      alert(data.error || '充值失败');
    } else {
      alert('充值成功');
    }
  } catch (err) {
    alert('充值请求失败');
  }
}

// 初始化
loadUser();
</script>
</body>
</html>
